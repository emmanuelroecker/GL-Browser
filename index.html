<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>GL-Browser</title>

  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #main {
      display: block;
      border: none;
    }
  </style>
</head>

<body>
  <div id="header">
    <button id="goback" onclick="goBack()">Back</button>
    Url:
    <input id="urltext" type="text" onkeypress="return searchKeyPress(event);">
    <button id="refresh" onclick="refresh()">Refresh</button>
    <button id="dev" onclick="devTools()">Dev</button>
    <span id="indicator"></span>
  </div>
  <webview id="main">
  </webview>
</body>

<script>
  'use strict';

  let fs = require('fs');
  let yaml = require('js-yaml');
  let matchPattern = require('match-pattern');
  let directoryCfg = 'cfg';
  let fileCfg = 'config.yml';
  let cfg;

  try {
    cfg = yaml.safeLoad(fs.readFileSync(fileCfg, 'utf8'));
    cfg = cfg.map(function(elem) {
      let name = elem['name'];
      elem['css'] = fs.readFileSync(directoryCfg + "/" + name + ".css", 'utf-8');
      elem['js'] = fs.readFileSync(directoryCfg + "/" + name + ".js", 'utf-8');

      let patterns = elem['patterns'];
      elem['patterns'] = patterns.map(function(pattern) {
        pattern = matchPattern.parse(pattern);
        if (pattern === null) {
          console.log("Bad pattern : " + pattern + " in " + name);
        }
        return pattern;
      });
      return elem;
    });
  } catch (e) {
    console.log(e);
  }

  let injectCSS = "";
  let injectJS = "";
  let webview = document.getElementById("main");

  function refresh() {
    webview.reload();
  }

  function devTools() {
    webview.openDevTools();
  }

  function goBack() {
    webview.goBack();
  }

  function getToInject(url) {
    for (let elem of cfg) {
      let patterns = elem['patterns']
      for (let pattern of patterns) {
        if (pattern.test(url)) {
          injectCSS = elem['css'];
          injectJS = elem['js'];
          return;
        }
      };
    };
  }

  function searchKeyPress(e) {
    if (e.keyCode != 13)
      return true;

    let url = document.getElementById("urltext").value;
    getToInject(url);
    webview.src = url;
    return false;
  }

  function autoresize() {
    let header = document.getElementById("header");
    let webviewsize = window.innerHeight - header.offsetHeight;
    webview.style.height = webviewsize + "px";
  }

  window.onload = function() {
    let indicator = document.getElementById("indicator");
    let loadstart = function() {
      indicator.innerText = "loading...";
    };
    let loadstop = function() {
      indicator.innerText = "";
    };
    let loadfinish = function() {
      webview.insertCSS(injectCSS);
      webview.executeJavaScript(injectJS);
    };

    webview.addEventListener("did-start-loading", loadstart);
    webview.addEventListener("did-stop-loading", loadstop);
    webview.addEventListener("did-finish-load", loadfinish);

    autoresize();
  };

  window.onresize = function(event) {
    autoresize();
  };
</script>

</html>
